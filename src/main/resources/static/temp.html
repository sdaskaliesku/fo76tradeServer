<!DOCTYPE html>
<html lang="en">
<head lang="en">
  <meta charset="UTF-8"/>
  <title>Fallout76 trading hub</title>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
          integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
          crossorigin="anonymous"></script>
  <link href="https://unpkg.com/tabulator-tables@4.7.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript"
          src="https://unpkg.com/tabulator-tables@4.7.2/dist/js/tabulator.min.js"></script>

</head>
<style>
  #output-wrapper {
    display: none;
  }
</style>
<body>

<div>
  <h3>Input file:</h3>
  <label>
    ItemExtractorMod file:
    <input id="file" type="file">
  </label>
  <button id="prepare">Upload</button>
</div>

<div id="output-wrapper">
  <div>
    <button id="download-csv">Download CSV</button>
    <button id="download-json">Download JSON</button>
    <button id="download-html">Download HTML</button>
  </div>

  <div id="output"></div>
</div>

</body>
<script>
  let legendaryFormatter = (cell, index) => {
    try {
      return cell.getValue()[index].value;
    } catch (e) {

    }
    return 'None';
  };

  let table = new Tabulator('#output', {
    layout: 'fitColumns',
    placeholder: 'No Data Set',
    columns: [
      {title: 'Name', field: 'text', sorter: 'string', width: 200},
      {title: 'Type', field: 'filterFlag', sorter: 'string', width: 200},
      {title: 'Level', field: 'itemLevel', sorter: 'number', width: 200},
      {title: 'Legendary stars', field: 'numLegendaryStars', formatter: 'star', width: 200},
      {
        title: '1 star',
        field: 'legendaryMods',
        width: 200,
        formatter: (cell) => legendaryFormatter(cell, 0),
      },
      {
        title: '2 star',
        field: 'legendaryMods',
        width: 200,
        formatter: (cell) => legendaryFormatter(cell, 1),
      },
      {
        title: '3 star',
        field: 'legendaryMods',
        width: 200,
        formatter: (cell) => legendaryFormatter(cell, 2),
      },
    ],
  });
  $('#download-csv').click(() => {
    table.download('csv', 'data.csv');
  });

  $('#download-json').click(() => {
    table.download('json', 'data.json');
  });

  $('#download-html').click(() => {
    table.download('html', 'data.html', {style: true});
  });

  $(document).ready(function() {
    let modDataRequest = {};
    modDataRequest.filters = {
      legendaryOnly: true,
    };
    modDataRequest.modData = {};
    $('#file').on('change', function() {
      let fileReader = new FileReader();
      fileReader.onload = function() {
        modDataRequest.modData = JSON.parse(fileReader.result);
      };
      fileReader.readAsText($('#file').prop('files')[0]);
    });
    $('#prepare').click(() => {
      fetch('items/prepareModData', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(modDataRequest),
      }).then((resp) => resp.json()).then(data => {
        table.setData(data);
        $('#output-wrapper').show();
      });
    });
  });
</script>
</html>